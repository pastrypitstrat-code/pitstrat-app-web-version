<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pit Strategy Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(to bottom, #0099ff, #0066cc);
            color: white;
            border: 2px solid #00aaff;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to bottom, #00aaff, #0088ee);
        }
        
        .btn-success {
            background: linear-gradient(to bottom, #00cc00, #009900);
            color: white;
            border: 2px solid #00dd00;
        }
        
        .btn-danger {
            background: linear-gradient(to bottom, #ff4444, #cc0000);
            color: white;
            border: 2px solid #ff6666;
        }
        
        .btn-warning {
            background: linear-gradient(to bottom, #ff9900, #cc7700);
            color: white;
            border: 2px solid #ffaa00;
        }
        
        .login-page, .main-app {
            display: none;
        }
        
        .login-page.active, .main-app.active {
            display: block;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }
        
        .login-container h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .login-container p {
            margin-bottom: 30px;
            color: #aaa;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .input-with-btn {
            display: flex;
            gap: 5px;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #444;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 14px;
        }
        
        .eye-btn {
            width: 40px;
            padding: 0;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #444;
        }
        
        .login-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .login-buttons button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
        }
        
        .calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .calc-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-group label {
            font-size: 11px;
            font-weight: bold;
        }
        
        select, input[type="text"], input[type="number"] {
            padding: 8px;
            border: 2px solid #555;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: black;
            font-size: 12px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .results {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.8), rgba(30, 30, 30, 0.8));
            border: 2px solid #ff4444;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            overflow-y: auto;
        }
        
        .results h2 {
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .result-item {
            background: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(30, 30, 30, 0.9));
            border: 2px solid #ff4444;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .result-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            padding: 0;
            font-size: 12px;
        }
        
        .result-text {
            white-space: pre-wrap;
            font-size: 11px;
            font-family: monospace;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .data-list {
            background: white;
            color: black;
            padding: 10px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .data-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        
        .data-item:hover {
            background: #f0f0f0;
        }
        
        .data-item.selected {
            background: #0099ff;
            color: white;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .calculator {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page active" id="loginPage">
        <div class="login-container">
            <h1>Pit Strategy Calculator</h1>
            <p>Sign in to sync your data</p>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label>Password:</label>
                <div class="input-with-btn">
                    <input type="password" id="loginPassword" placeholder="Password">
                    <button class="eye-btn" onmousedown="showPassword('loginPassword')" onmouseup="hidePassword('loginPassword')">üëÅ</button>
                </div>
            </div>
            
            <div class="form-group" id="confirmGroup" style="display: none;">
                <label>Confirm Password:</label>
                <div class="input-with-btn">
                    <input type="password" id="confirmPassword" placeholder="Confirm Password">
                    <button class="eye-btn" onmousedown="showPassword('confirmPassword')" onmouseup="hidePassword('confirmPassword')">üëÅ</button>
                </div>
            </div>
            
            <div class="login-buttons">
                <button class="btn-danger" onclick="signIn()">Sign In</button>
                <button class="btn-danger" onclick="switchToSignUp()">Sign Up</button>
            </div>
            
            <div class="login-buttons" id="signupButtons" style="display: none;">
                <button class="btn-danger" onclick="switchToSignIn()">Back to Sign In</button>
                <button class="btn-success" onclick="signUp()">Create Account</button>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <div class="container">
            <div class="header">
                <h1>Pit Strategy Calculator</h1>
                <div class="header-buttons">
                    <button class="btn-warning" onclick="showSubscription()">üí≥ Subscription</button>
                    <button class="btn-danger" onclick="signOut()">üö™ Sign Out</button>
                </div>
            </div>
            
            <div class="calculator">
                <div class="calc-inputs">
                    <div class="input-group">
                        <label>Car</label>
                        <select id="carSelect" onchange="updateTracks()">
                            <option value="">Select Car</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Track</label>
                        <select id="trackSelect">
                            <option value="">Select Track</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Race Type</label>
                        <select id="raceType">
                            <option value="lap">Lap Race</option>
                            <option value="time">Time Race (min)</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label>Race Distance</label>
                        <input type="number" id="raceDistance" placeholder="Total laps or time">
                    </div>
                    
                    <div class="input-group">
                        <label>Lap Time (MM:SS)</label>
                        <input type="text" id="lapTime" placeholder="MM:SS">
                    </div>
                    
                    <div class="input-group">
                        <label>Tire Dropoff Threshold (%)</label>
                        <input type="number" id="tireThreshold" value="30">
                    </div>
                    
                    <div class="input-group">
                        <label>Fuel Buffer (L)</label>
                        <input type="number" id="fuelBuffer" value="2.5" step="0.1">
                    </div>
                    
                    <div class="input-group">
                        <label>Tire Buffer (%)</label>
                        <input type="number" id="tireBuffer" value="5">
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDetails">
                        <label>Show lap details</label>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="calculateStrategy()">‚ö° Calculate Strategy</button>
                        <button class="btn-success" onclick="showDataManager()">üìä Manage Data</button>
                    </div>
                </div>
                
                <div class="results">
                    <h2>Strategy Results</h2>
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Data Manager Modal -->
    <div class="modal" id="dataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Car/Track Data</h2>
                <button class="btn-danger" onclick="closeDataManager()">‚úï</button>
            </div>
            <div class="data-list" id="dataList"></div>
            <div class="modal-buttons">
                <button class="btn-success" onclick="showAddDataForm()">Add New</button>
                <button class="btn-danger" onclick="deleteSelected()">Delete Selected</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBMZJgCpDCNO0YmbJ2e11LvAQmYcdJMWgE",
            authDomain: "pitstratergyapp.firebaseapp.com",
            projectId: "pitstratergyapp",
            storageBucket: "pitstratergyapp.firebasestorage.app",
            databaseURL: "https://pitstratergyapp-default-rtdb.firebaseio.com"
        };
        
        let currentUser = null;
        let userToken = null;
        let userData = {};
        let selectedDataItem = null;
        
        // Auth functions
        async function signUp() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords don\'t match');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            try {
                const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, returnSecureToken: true })
                });
                
                const data = await response.json();
                
                if (data.idToken) {
                    currentUser = data.localId;
                    userToken = data.idToken;
                    await loadUserData();
                    showMainApp();
                } else {
                    alert(data.error?.message || 'Sign up failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        async function signIn() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }
            
            try {
                const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${firebaseConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, returnSecureToken: true })
                });
                
                const data = await response.json();
                
                if (data.idToken) {
                    currentUser = data.localId;
                    userToken = data.idToken;
                    await loadUserData();
                    showMainApp();
                } else {
                    alert(data.error?.message || 'Sign in failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        function signOut() {
            currentUser = null;
            userToken = null;
            userData = {};
            document.getElementById('loginPage').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
        }
        
        function showMainApp() {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            refreshUI();
        }
        
        function showPassword(id) {
            document.getElementById(id).type = 'text';
        }
        
        function hidePassword(id) {
            document.getElementById(id).type = 'password';
        }
        
        function switchToSignUp() {
            document.getElementById('confirmGroup').style.display = 'block';
            document.querySelector('.login-buttons').style.display = 'none';
            document.getElementById('signupButtons').style.display = 'flex';
        }
        
        function switchToSignIn() {
            document.getElementById('confirmGroup').style.display = 'none';
            document.querySelector('.login-buttons').style.display = 'flex';
            document.getElementById('signupButtons').style.display = 'none';
        }
        
        // Data functions
        async function loadUserData() {
            if (!currentUser || !userToken) return;
            
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/users/${currentUser}/data.json?auth=${userToken}`);
                const data = await response.json();
                userData = data || {};
            } catch (error) {
                console.error('Error loading data:', error);
                userData = {};
            }
        }
        
        async function saveUserData() {
            if (!currentUser || !userToken) return;
            
            try {
                await fetch(`${firebaseConfig.databaseURL}/users/${currentUser}/data.json?auth=${userToken}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        function refreshUI() {
            const carSelect = document.getElementById('carSelect');
            carSelect.innerHTML = '<option value="">Select Car</option>';
            
            for (const car in userData) {
                const option = document.createElement('option');
                option.value = car;
                option.textContent = car;
                carSelect.appendChild(option);
            }
        }
        
        function updateTracks() {
            const car = document.getElementById('carSelect').value;
            const trackSelect = document.getElementById('trackSelect');
            trackSelect.innerHTML = '<option value="">Select Track</option>';
            
            if (car && userData[car]) {
                for (const track in userData[car]) {
                    const option = document.createElement('option');
                    option.value = track;
                    option.textContent = track;
                    trackSelect.appendChild(option);
                }
            }
        }
        
        // Calculator functions
        function calculateTireDropoff(tireDegPerPercent, tirePercent) {
            const tireWear = 100 - tirePercent;
            return tireWear * tireDegPerPercent;
        }
        
        function findOptimalPitLap(totalLaps, fuelPerLap, tank, tireDegPerPercent, tireDropoffThreshold, fuelBuffer, tireBuffer) {
            const usableFuel = tank - fuelBuffer;
            const maxFuelLaps = Math.floor(usableFuel / fuelPerLap);
            
            const tireWearPerLap = 1.0;
            const adjustedTireThreshold = tireDropoffThreshold + tireBuffer;
            const maxTireLaps = Math.floor((100 - adjustedTireThreshold) / tireWearPerLap);
            
            const stintLength = Math.min(maxFuelLaps, maxTireLaps);
            
            const stints = [];
            let lapsRemaining = totalLaps;
            let lapCounter = 0;
            
            while (lapsRemaining > 0) {
                const currentStint = Math.min(stintLength, lapsRemaining);
                lapCounter += currentStint;
                stints.push({
                    pitLap: lapCounter,
                    stintLength: currentStint,
                    reason: currentStint === maxFuelLaps ? 'fuel' : 'tires'
                });
                lapsRemaining -= currentStint;
            }
            
            return stints;
        }
        
        function calculateStrategy() {
            const car = document.getElementById('carSelect').value;
            const track = document.getElementById('trackSelect').value;
            
            if (!car || !userData[car] || !userData[car][track]) {
                addResult('ERROR: No data available. Use "Manage Data" to add car/track data first.');
                return;
            }
            
            const info = userData[car][track];
            const raceType = document.getElementById('raceType').value;
            const raceDistance = parseFloat(document.getElementById('raceDistance').value);
            const lapTimeStr = document.getElementById('lapTime').value;
            const tireThreshold = parseFloat(document.getElementById('tireThreshold').value);
            const fuelBuffer = parseFloat(document.getElementById('fuelBuffer').value);
            const tireBuffer = parseFloat(document.getElementById('tireBuffer').value);
            const showDetails = document.getElementById('showDetails').checked;
            
            if (!raceDistance || !lapTimeStr) {
                addResult('ERROR: Invalid inputs');
                return;
            }
            
            // Parse lap time
            let lapTimeSec;
            if (lapTimeStr.includes(':')) {
                const [mins, secs] = lapTimeStr.split(':');
                lapTimeSec = parseFloat(mins) * 60 + parseFloat(secs);
            } else {
                lapTimeSec = parseFloat(lapTimeStr);
            }
            
            const totalLaps = raceType === 'time' 
                ? Math.floor((raceDistance * 60) / lapTimeSec)
                : Math.floor(raceDistance);
            
            const stints = findOptimalPitLap(
                totalLaps,
                info.fuel_per_lap,
                info.tank_size,
                info.tire_deg_per_percent,
                tireThreshold,
                fuelBuffer,
                tireBuffer
            );
            
            let result = `STRATEGY\n${car} @ ${track}\n`;
            result += `Laps: ${totalLaps} | Lap: ${lapTimeSec.toFixed(1)}s\n`;
            result += `Fuel/lap: ${info.fuel_per_lap}L | Buffers: ${fuelBuffer}L fuel, ${tireBuffer}% tire\n`;
            result += `Tire threshold: ${tireThreshold}%\n\n`;
            
            const totalPitTime = (stints.length - 1) * info.pit_time_loss;
            const raceTime = (totalLaps * lapTimeSec) + totalPitTime;
            
            result += `PIT STOPS: ${stints.length - 1}\n`;
            result += `Race time: ${Math.floor(raceTime / 60)}m ${Math.floor(raceTime % 60)}s\n\n`;
            
            for (let i = 0; i < stints.length - 1; i++) {
                const limit = stints[i].reason === 'fuel' ? 'FUEL' : 'TIRES';
                result += `PIT ${i + 1}: Lap ${stints[i].pitLap} (${limit})\n`;
            }
            
            if (showDetails) {
                result += '\n--- Lap Details ---\n';
                let lapCounter = 0;
                for (let i = 0; i < stints.length; i++) {
                    for (let lap = 0; lap < Math.min(5, stints[i].stintLength); lap++) {
                        lapCounter++;
                        const tirePct = 100 - (lap * 1.0);
                        const penalty = calculateTireDropoff(info.tire_deg_per_percent, tirePct);
                        const lapTime = info.base_laptime + penalty;
                        result += `L${lapCounter}: ${lapTime.toFixed(2)}s\n`;
                    }
                    if (stints[i].stintLength > 5) {
                        result += `... (+${stints[i].stintLength - 5} laps)\n`;
                        lapCounter += stints[i].stintLength - 5;
                    }
                    if (lapCounter < totalLaps) {
                        result += 'PIT\n';
                    }
                }
            }
            
            addResult(result);
        }
        
        function addResult(text) {
            const container = document.getElementById('resultsContainer');
            const item = document.createElement('div');
            item.className = 'result-item';
            item.innerHTML = `
                <button class="result-close btn-danger" onclick="this.parentElement.remove()">‚úï</button>
                <div class="result-text">${text}</div>
            `;
            container.insertBefore(item, container.firstChild);
        }
        
        // Data manager
        function showDataManager() {
            const modal = document.getElementById('dataModal');
            modal.classList.add('active');
            refreshDataList();
        }
        
        function closeDataManager() {
            document.getElementById('dataModal').classList.remove('active');
        }
        
        function refreshDataList() {
            const list = document.getElementById('dataList');
            list.innerHTML = '';
            
            for (const car in userData) {
                for (const track in userData[car]) {
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    item.textContent = `${car} - ${track}`;
                    item.onclick = function() {
                        document.querySelectorAll('.data-item').forEach(i => i.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDataItem = { car, track };
                    };
                    list.appendChild(item);
                }
            }
        }
        
        function deleteSelected() {
            if (!selectedDataItem) {
                alert('Select data to delete');
                return;
            }
            
            if (!confirm(`Delete ${selectedDataItem.car} - ${selectedDataItem.track}?`)) {
                return;
            }
            
            delete userData[selectedDataItem.car][selectedDataItem.track];
            if (Object.keys(userData[selectedDataItem.car]).length === 0) {
                delete userData[selectedDataItem.car];
            }
            
            saveUserData();
            refreshDataList();
            refreshUI();
            selectedDataItem = null;
        }
        
        function showAddDataForm() {
            alert('Add data form coming soon! Use the desktop app to add data for now.');
        }
        
        function showSubscription() {
            alert('Subscription System - Coming Soon!\n\nPlanned Tiers:\n‚Ä¢ Free: $0/month\n‚Ä¢ Basic: $2/month\n‚Ä¢ Premium: $5/month\n\nAll premium features are currently available to everyone!');
        }
    </script>
</body>
</html>
